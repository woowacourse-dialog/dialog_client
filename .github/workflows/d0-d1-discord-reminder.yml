name: D-N Discord Reminder

on:
  # ë§¤ì¼ í•œêµ­ì‹œê°„ 12ì‹œ (UTC 03:00)
  schedule:
    - cron: "0 3 * * *"
  workflow_dispatch:

jobs:
  notify-dn:
    runs-on: ubuntu-latest

    steps:
      - name: Fetch D-0 / D-1 PRs
        id: fetch_prs
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const LABEL_D0 = "D-0";
            const LABEL_D1 = "D-1";

            // ğŸ‘‰ github.rest.pulls.list ë¡œ ë³€ê²½
            const { data: prs } = await github.rest.pulls.list({
              owner,
              repo,
              state: "open",
              per_page: 100,
            });

            const d0 = [];
            const d1 = [];

            prs.forEach(pr => {
              const labels = pr.labels.map(l => l.name);

              const reviewers =
                pr.requested_reviewers.length > 0
                  ? pr.requested_reviewers.map(r => `@${r.login}`).join(", ")
                  : "ì—†ìŒ";

              const field = {
                name: `#${pr.number} ${pr.title}`,
                value: `ì‘ì„±ì: @${pr.user.login}\në¦¬ë·°ì–´: ${reviewers}\nğŸ”— ${pr.html_url}`
              };

              if (labels.includes(LABEL_D0)) d0.push(field);
              if (labels.includes(LABEL_D1)) d1.push(field);
            });

            core.setOutput("has_d0", d0.length > 0);
            core.setOutput("has_d1", d1.length > 0);
            core.setOutput("d0_json", JSON.stringify(d0));
            core.setOutput("d1_json", JSON.stringify(d1));

      # -----------------------------
      # D-0 ì „ì†¡
      # -----------------------------
      - name: Send D-0 Discord Embed
        if: steps.fetch_prs.outputs.has_d0 == 'true'
        env:
          WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          FIELDS_JSON: ${{ steps.fetch_prs.outputs.d0_json }}
        run: |
          payload=$(jq -n \
            --argjson fields "$FIELDS_JSON" \
            '{
              embeds: [
                {
                  title: "â° D-0 PR ë¦¬ë·° ë§ˆê° ì„ë°•",
                  description: "ì˜¤ëŠ˜ ë¦¬ë·° ë§ˆê°ì¸ PR ëª©ë¡ì…ë‹ˆë‹¤.\në¹ ë¥¸ í™•ì¸ ë¶€íƒë“œë¦½ë‹ˆë‹¤!",
                  color: 16734296,
                  fields: $fields,
                  footer: { text: "ë‚¨ì€ ê¸°ê°„: D-0" }
                }
              ]
            }')
          curl -X POST \
            -H "Content-Type: application/json" \
            -d "$payload" \
            "$WEBHOOK_URL"

      # -----------------------------
      # D-1 ì „ì†¡
      # -----------------------------
      - name: Send D-1 Discord Embed
        if: steps.fetch_prs.outputs.has_d1 == 'true'
        env:
          WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          FIELDS_JSON: ${{ steps.fetch_prs.outputs.d1_json }}
        run: |
          payload=$(jq -n \
            --argjson fields "$FIELDS_JSON" \
            '{
              embeds: [
                {
                  title: "ğŸ“Œ D-1 PR ë¦¬ë·° ì‚¬ì „ ì•Œë¦¼",
                  description: "ë‚´ì¼ ë¦¬ë·° ë§ˆê°ì¸ PR ëª©ë¡ì…ë‹ˆë‹¤.\në¯¸ë¦¬ ê²€í†  ë¶€íƒë“œë¦½ë‹ˆë‹¤!",
                  color: 3447003,
                  fields: $fields,
                  footer: { text: "ë‚¨ì€ ê¸°ê°„: D-1" }
                }
              ]
            }')
          curl -X POST \
            -H "Content-Type: application/json" \
            -d "$payload" \
            "$WEBHOOK_URL"
